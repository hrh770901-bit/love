import React, { useState, useEffect, useRef } from 'react';
import { Heart, Wind, BookOpen, Phone, AlertCircle, Calendar, User, LogOut, Send, Mic, Play, Pause, X, Wifi, WifiOff } from 'lucide-react';
import { initializeApp } from "firebase/app";
import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc } from "firebase/firestore";

// --- â­ ì„ ìƒë‹˜ì˜ LOVE í”„ë¡œì íŠ¸ ë¹„ë°€ ì—´ì‡  (ì„¤ì • ì™„ë£Œ) ---
const firebaseConfig = {
  apiKey: "AIzaSyATOUHaxLyQpKSnh3tSTKbE545Z3hrpd00",
  authDomain: "love-c5ddb.firebaseapp.com",
  projectId: "love-c5ddb",
  storageBucket: "love-c5ddb.firebasestorage.app",
  messagingSenderId: "333805011394",
  appId: "1:333805011394:web:50dcb1c7544ed07f23d65b"
};

// Firebase ì´ˆê¸°í™”
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ì•± ID (ë°ì´í„° ì €ì¥ ê²½ë¡œìš© - ì„ì˜ë¡œ ì„¤ì • ê°€ëŠ¥)
const appId = 'mind-garden-class-6-2';

// --- ë°ì´í„° ë° ìƒìˆ˜ ì •ì˜ ---

const MOOD_COLORS = [
  { id: 'joy', color: 'bg-yellow-300', text: 'ê¸°ì¨/í¬ë§', message: 'ë…¸ë€ í–‡ì‚´ì²˜ëŸ¼ ë°ì€ ë§ˆìŒì´êµ¬ë‚˜!' },
  { id: 'calm', color: 'bg-green-300', text: 'í‰ì˜¨/íœ´ì‹', message: 'ì´ˆë¡ ë‚˜ë¬´ì²˜ëŸ¼ í¸ì•ˆí•œ ëŠë‚Œì´ë„¤.' },
  { id: 'sad', color: 'bg-blue-300', text: 'ìŠ¬í””/ìš°ìš¸', message: 'íŒŒë€ ë¹„ê°€ ë‚´ë¦¬ëŠ”êµ¬ë‚˜. ê´œì°®ì•„, ê·¸ëŸ´ ìˆ˜ ìˆì–´.' },
  { id: 'angry', color: 'bg-red-400', text: 'í™”ë‚¨/ì—ë„ˆì§€', message: 'ë¶‰ì€ ë¶ˆê½ƒì´ ì¼ì–´ë‚˜ëŠ”êµ¬ë‚˜. ì‹¬í˜¸í¡ì„ í•´ë³¼ê¹Œ?' },
  { id: 'anxious', color: 'bg-purple-300', text: 'ë¶ˆì•ˆ/ê³ ë¯¼', message: 'ë³´ëë¹› ì•ˆê°œ ì†ì— ìˆë‹ˆ? ì„ ìƒë‹˜ì´ ì† ì¡ì•„ì¤„ê²Œ.' },
];

const MEDITATION_SCRIPTS = [
  "ì, í¸ì•ˆí•˜ê²Œ ì•‰ì•„ë³´ì. ì„ ìƒë‹˜ì´ ì¤€ ë¼ë²¤ë” ì˜¤ì¼ í–¥ê¸°ë¥¼ ê¹Šê²Œ ë“¤ì´ë§ˆì…”ë´... (ìˆ¨ ë“¤ì´ë§ˆì‹œê¸°)",
  "ë‚´ ë§ˆìŒì†ì— ìˆëŠ” ë¶ˆì•ˆí•œ í’ì„ ì´ ì²œì²œíˆ ë°”ëŒì´ ë¹ ì ¸ë‚˜ê°„ë‹¤ê³  ìƒìƒí•´ë´... (ìˆ¨ ë‚´ì‰¬ê¸°)",
  "ë„ˆëŠ” ì•ˆì „í•´. ì§€ê¸ˆ ì´ ìˆœê°„, ë„ˆì˜ ìˆ¨ì†Œë¦¬ì—ë§Œ ì§‘ì¤‘í•´ ë³´ì."
];

export default function MindGardenApp() {
  const [user, setUser] = useState(null);
  const [userType, setUserType] = useState(null); // 'student' or 'teacher' or null
  const [moodLogs, setMoodLogs] = useState([]);
  const [journals, setJournals] = useState([]);
  const [sosActive, setSosActive] = useState(false);
  const [isOnline, setIsOnline] = useState(false);
  const [authError, setAuthError] = useState(null);

  // 1. Auth ì´ˆê¸°í™” (ì„ ìƒë‹˜ í”„ë¡œì íŠ¸ìš© ìµëª… ë¡œê·¸ì¸)
  useEffect(() => {
    const initAuth = async () => {
      try {
        // ì„ ìƒë‹˜ì´ ì„¤ì •í•˜ì‹  'ìµëª… ë¡œê·¸ì¸'ì„ ì‹œë„í•©ë‹ˆë‹¤.
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Auth Error:", error);
        setAuthError(error.message);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setIsOnline(!!u);
    });
    return () => unsubscribe();
  }, []);

  // 2. ë°ì´í„° ì‹¤ì‹œê°„ ë™ê¸°í™” (Firestore)
  useEffect(() => {
    if (!user) return;

    // ê°ì • ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
    const moodQuery = collection(db, 'artifacts', appId, 'public', 'data', 'mood_logs');
    const unsubMood = onSnapshot(moodQuery, (snapshot) => {
      const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      // í´ë¼ì´ì–¸íŠ¸ ì¸¡ ì •ë ¬ (ìµœì‹ ìˆœ)
      logs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      setMoodLogs(logs);
    }, (error) => console.error("Mood fetch error:", error));

    // ì¼ê¸° ë¡œê·¸ ë¶ˆëŸ¬ì˜¤ê¸°
    const journalQuery = collection(db, 'artifacts', appId, 'public', 'data', 'journals');
    const unsubJournal = onSnapshot(journalQuery, (snapshot) => {
      const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      logs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      setJournals(logs);
    }, (error) => console.error("Journal fetch error:", error));

    return () => {
      unsubMood();
      unsubJournal();
    };
  }, [user]);

  // ë¡œê·¸ì¸ í™”ë©´
  if (!userType) {
    return (
      <div className="flex flex-col items-center justify-center h-screen bg-pink-50 p-6 font-sans">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center space-y-8 animate-fade-in-up">
          <div className="space-y-2">
            <h1 className="text-3xl font-bold text-gray-800">ğŸŒ± ë§ˆìŒ ì •ì›</h1>
            <p className="text-gray-500">ë„ˆì™€ ë‚˜, ìš°ë¦¬ê°€ ì—°ê²°ë˜ëŠ” ê³³</p>
          </div>
          
          <div className="space-y-4">
            <button 
              onClick={() => setUserType('student')}
              className="w-full py-4 bg-emerald-100 hover:bg-emerald-200 text-emerald-800 rounded-2xl text-lg font-semibold transition-all transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <User size={24} />
              í•™ìƒ ì…ì¥í•˜ê¸°
            </button>
            <button 
              onClick={() => setUserType('teacher')}
              className="w-full py-4 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-2xl text-lg font-semibold transition-all transform hover:scale-105 flex items-center justify-center gap-2"
            >
              <BookOpen size={24} />
              ì„ ìƒë‹˜/í•™ë¶€ëª¨ ì…ì¥
            </button>
          </div>
          
          <div className="flex flex-col items-center justify-center gap-2 text-xs text-gray-400 mt-8">
             <div className="flex items-center gap-2">
               {isOnline ? <Wifi size={14} className="text-emerald-500"/> : <WifiOff size={14} className="text-red-400"/>}
               {isOnline ? "ì„ ìƒë‹˜ ì„œë²„(LOVE) ì—°ê²°ë¨" : "ì„œë²„ ì—°ê²° ì¤‘..."}
             </div>
             {authError && <p className="text-red-400 text-[10px] max-w-[200px] text-center">ì˜¤ë¥˜: ë„ë©”ì¸ í—ˆìš©ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br/>({authError})</p>}
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="h-full w-full bg-gray-100 flex justify-center overflow-hidden">
      <div className="w-full max-w-md bg-white h-full shadow-2xl relative flex flex-col">
        {userType === 'student' ? (
          <StudentView 
            moodLogs={moodLogs} 
            journals={journals}
            setSosActive={setSosActive}
            sosActive={sosActive}
            onLogout={() => setUserType(null)}
            db={db}
            appId={appId}
          />
        ) : (
          <TeacherView 
            moodLogs={moodLogs} 
            journals={journals}
            onLogout={() => setUserType(null)}
            db={db}
            appId={appId}
          />
        )}
      </div>
    </div>
  );
}

// --- í•™ìƒìš© ë·° ---
function StudentView({ moodLogs, journals, setSosActive, sosActive, onLogout, db, appId }) {
  const [activeTab, setActiveTab] = useState('home');
  const [todayMood, setTodayMood] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [latestMessage, setLatestMessage] = useState(null);

  // ì„ ìƒë‹˜ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ì‹¤ì‹œê°„)
  useEffect(() => {
    const msgQuery = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const unsubscribe = onSnapshot(msgQuery, (snapshot) => {
      const msgs = snapshot.docs.map(doc => doc.data());
      // ìµœì‹ ìˆœ ì •ë ¬
      msgs.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
      if (msgs.length > 0) {
        setLatestMessage(msgs[0]);
      }
    });
    return () => unsubscribe();
  }, [db, appId]);

  const handleMoodSelect = async (moodItem) => {
    setIsSaving(true);
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mood_logs'), {
        mood: moodItem.id,
        note: '', // ì¶”í›„ ë…¸íŠ¸ ì¶”ê°€ ê°€ëŠ¥
        date: new Date().toLocaleDateString(),
        timestamp: serverTimestamp(),
        studentName: 'ì§€ì€'
      });
      setTodayMood(moodItem);
    } catch (e) {
      alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
    }
    setIsSaving(false);
  };

  return (
    <div className="flex-1 flex flex-col relative bg-amber-50/30">
      <header className="p-6 pt-12 flex justify-between items-center bg-white shadow-sm rounded-b-3xl z-10">
        <div>
          <h2 className="text-2xl font-bold text-gray-800">ì•ˆë…•, ì§€ì€ì•„! ğŸ‘‹</h2>
          <p className="text-gray-500 text-sm">ì˜¤ëŠ˜ë„ ë„ˆëŠ” ì†Œì¤‘í•œ ì‚¬ëŒì´ì•¼.</p>
        </div>
        <button onClick={onLogout} className="text-gray-400 hover:text-gray-600">
          <LogOut size={20} />
        </button>
      </header>

      <main className="flex-1 overflow-y-auto p-6 space-y-6 pb-24">
        <button 
          onClick={() => setSosActive(true)}
          className="w-full bg-red-100 hover:bg-red-200 text-red-600 p-4 rounded-2xl flex items-center justify-center gap-2 font-bold shadow-sm transition-all animate-pulse"
        >
          <AlertCircle size={24} />
          ì§€ê¸ˆ ë§ˆìŒì´ ë„ˆë¬´ í˜ë“¤ì–´ìš” (SOS)
        </button>

        {activeTab === 'home' && (
          <div className="space-y-6 animate-fade-in">
            <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
              <h3 className="text-lg font-semibold mb-4 text-gray-700">ì˜¤ëŠ˜ ë„ˆì˜ ë§ˆìŒ ìƒ‰ê¹”ì€?</h3>
              {todayMood ? (
                <div className={`p-6 rounded-2xl ${todayMood.color} text-center space-y-2`}>
                  <div className="text-3xl">âœ¨</div>
                  <p className="font-bold text-gray-800 text-lg">{todayMood.text}</p>
                  <p className="text-gray-800/80 text-sm">{todayMood.message}</p>
                  <button 
                    onClick={() => setTodayMood(null)} 
                    className="text-xs text-gray-600 underline mt-2 block w-full"
                  >
                    ë‹¤ì‹œ ì„ íƒí•˜ê¸°
                  </button>
                </div>
              ) : (
                <div className="grid grid-cols-5 gap-2">
                  {MOOD_COLORS.map((mood) => (
                    <button
                      key={mood.id}
                      disabled={isSaving}
                      onClick={() => handleMoodSelect(mood)}
                      className={`h-14 w-full rounded-2xl ${mood.color} hover:opacity-80 transition-transform hover:scale-110 shadow-sm disabled:opacity-50`}
                      aria-label={mood.text}
                    />
                  ))}
                </div>
              )}
            </div>

            <div className="bg-blue-50 p-6 rounded-3xl shadow-sm border border-blue-100 relative overflow-hidden transition-all duration-500">
              <div className="absolute -right-4 -top-4 bg-blue-100 w-24 h-24 rounded-full opacity-50"></div>
              <h3 className="text-lg font-semibold mb-2 text-blue-800 flex items-center gap-2">
                <Heart size={18} className="fill-blue-800" /> ì„ ìƒë‹˜ì˜ ì‘ì›
              </h3>
              <p className="text-blue-900 leading-relaxed font-medium">
                {latestMessage 
                  ? `"${latestMessage.text}"` 
                  : `"ì§€ì€ì•„, ì–´ì œ ì²´ìœ¡ ì‹œê°„ì— ì¹œêµ¬ë¥¼ ë„ì™€ì£¼ëŠ” ëª¨ìŠµì´ ì •ë§ ë©‹ì§€ë”ë¼. í˜ë“  ì¼ì´ ìˆìœ¼ë©´ ì–¸ì œë“  'ë¹ˆ ì˜ì'ì— í„¸ì–´ë†“ìœ¼ë ´. ì„ ìƒë‹˜ì€ ëŠ˜ ë„¤ í¸ì´ì•¼."`
                }
              </p>
              <p className="text-right text-xs text-blue-400 mt-2">
                - {latestMessage ? 'ë³´ê±´ ì„ ìƒë‹˜ (ìƒˆ ë©”ì‹œì§€)' : 'ë³´ê±´ ì„ ìƒë‹˜'} -
              </p>
            </div>
          </div>
        )}

        {activeTab === 'meditation' && <MeditationPlayer />}
        
        {activeTab === 'journal' && <JournalEditor db={db} appId={appId} />}

      </main>

      {sosActive && (
        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
          <div className="bg-white w-full rounded-3xl p-8 space-y-6 text-center animate-bounce-in relative">
            <button 
              onClick={() => setSosActive(false)}
              className="absolute top-4 right-4 p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-full transition-colors"
            >
              <X size={24} />
            </button>
            <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto">
              <Phone size={32} />
            </div>
            <div>
              <h3 className="text-2xl font-bold text-gray-800 mb-2">í˜¼ìê°€ ì•„ë‹ˆì•¼</h3>
              <p className="text-gray-500">ì§€ê¸ˆ ë°”ë¡œ ëª©ì†Œë¦¬ë¥¼ ë“¤ë ¤ì¤„ë˜?</p>
            </div>
            <div className="space-y-3">
              <button className="w-full py-4 bg-pink-500 text-white rounded-xl font-bold text-lg shadow-lg hover:bg-pink-600 transition-colors">
                ì—„ë§ˆì—ê²Œ ì „í™”í•˜ê¸°
              </button>
              <button className="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold text-lg hover:bg-gray-300 transition-colors">
                ìƒë‹´ì„¼í„° (1388) ì—°ê²°
              </button>
            </div>
          </div>
        </div>
      )}

      <nav className="absolute bottom-0 w-full bg-white border-t border-gray-100 flex justify-around items-center p-4 pb-8 rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <NavButton active={activeTab === 'home'} onClick={() => setActiveTab('home')} icon={<Heart size={24} />} label="í™ˆ" />
        <NavButton active={activeTab === 'meditation'} onClick={() => setActiveTab('meditation')} icon={<Wind size={24} />} label="í˜¸í¡/ëª…ìƒ" />
        <NavButton active={activeTab === 'journal'} onClick={() => setActiveTab('journal')} icon={<BookOpen size={24} />} label="ë§ˆìŒì¼ê¸°" />
      </nav>
    </div>
  );
}

// --- ì„ ìƒë‹˜ìš© ë·° ---
function TeacherView({ moodLogs, journals, onLogout, db, appId }) {
  const dangerSignals = moodLogs.filter(log => log.mood === 'sad' || log.mood === 'angry').length;
  const [message, setMessage] = useState('');

  const handleSendMessage = async () => {
    if(!message.trim()) return;
    try {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
            text: message,
            timestamp: serverTimestamp(),
            sender: 'teacher',
            receiver: 'student'
        });
        alert("ì§€ì€ì´ì—ê²Œ ì‘ì› ë©”ì‹œì§€ê°€ ì‹¤ì œë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
        setMessage('');
    } catch (e) {
        console.error(e);
        alert("ì „ì†¡ ì‹¤íŒ¨: " + e.message);
    }
  };

  return (
    <div className="flex-1 flex flex-col bg-slate-50">
      <header className="p-6 pt-12 bg-white shadow-sm flex justify-between items-center">
        <div>
          <h2 className="text-xl font-bold text-slate-800">ğŸ‘©â€ğŸ« í•™ìƒ ì¼€ì–´ ëŒ€ì‹œë³´ë“œ</h2>
          <p className="text-sm text-slate-500 flex items-center gap-1">
            <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
            ì‹¤ì‹œê°„ ì—°ë™ì¤‘ â€¢ ê¹€ì§€ì€ í•™ìƒ
          </p>
        </div>
        <button onClick={onLogout} className="text-gray-400 hover:text-gray-600">
          <LogOut size={20} />
        </button>
      </header>

      <main className="p-6 space-y-6 overflow-y-auto pb-10">
        <div className="grid grid-cols-2 gap-4">
          <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
            <h4 className="text-xs font-bold text-slate-400 uppercase mb-2">ìµœê·¼ ê°ì • ìƒíƒœ</h4>
            <div className="flex items-end gap-1 h-16">
               {moodLogs.slice(0, 5).map((log, idx) => {
                 const colorClass = MOOD_COLORS.find(c => c.id === log.mood)?.color || 'bg-gray-200';
                 return (
                   <div key={idx} className={`flex-1 rounded-t-lg ${colorClass} opacity-80 h-full`} title={log.date}></div>
                 )
               })}
               {moodLogs.length === 0 && <div className="text-xs text-gray-300 w-full text-center self-center">ê¸°ë¡ ëŒ€ê¸°ì¤‘</div>}
            </div>
            <p className="text-xs text-slate-400 mt-2 text-right">ì‹¤ì‹œê°„ ë°˜ì˜ë¨</p>
          </div>
          
          <div className={`p-5 rounded-2xl shadow-sm border ${dangerSignals > 0 ? 'bg-red-50 border-red-100' : 'bg-emerald-50 border-emerald-100'}`}>
            <h4 className={`text-xs font-bold uppercase mb-2 ${dangerSignals > 0 ? 'text-red-400' : 'text-emerald-400'}`}>ê´€ì‹¬ í•„ìš” ì§€ìˆ˜</h4>
            <div className="flex items-center gap-2 mt-2">
              <AlertCircle size={28} className={dangerSignals > 0 ? 'text-red-500' : 'text-emerald-500'} />
              <span className={`text-2xl font-bold ${dangerSignals > 0 ? 'text-red-600' : 'text-emerald-600'}`}>
                {dangerSignals > 0 ? 'ì£¼ì˜' : 'ì•ˆì •'}
              </span>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
          <div className="p-4 border-b border-slate-50 flex justify-between items-center">
            <h3 className="font-bold text-slate-700">ğŸ“‹ ì‹¤ì‹œê°„ í™œë™ ê¸°ë¡</h3>
          </div>
          <div className="divide-y divide-slate-50 max-h-60 overflow-y-auto">
            {/* ê°ì • ë¡œê·¸ì™€ ì¼ê¸°ë¥¼ í•©ì³ì„œ ë³´ì—¬ì¤Œ (ê°„ë‹¨íˆ êµ¬í˜„) */}
            {moodLogs.map((log, idx) => {
              const moodData = MOOD_COLORS.find(c => c.id === log.mood);
              return (
                <div key={log.id} className="p-4 hover:bg-slate-50 transition-colors animate-fade-in">
                  <div className="flex items-center gap-3 mb-2">
                    <div className={`w-3 h-3 rounded-full ${moodData?.color}`}></div>
                    <span className="text-sm font-semibold text-slate-700">ê°ì • ì²´í¬</span>
                    <span className="text-xs text-slate-400 ml-auto">
                      {log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'ë°©ê¸ˆ ì „'}
                    </span>
                  </div>
                  <p className="text-sm text-slate-600 pl-6 border-l-2 border-slate-100">
                     <span className="font-medium text-slate-800">[{moodData?.text}]</span> ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤.
                  </p>
                </div>
              );
            })}
             {moodLogs.length === 0 && <div className="p-8 text-center text-slate-400">ì•„ì§ í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>}
          </div>
        </div>

        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
           <h3 className="font-bold text-slate-700 mb-3">ğŸ’Œ ê²©ë ¤ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
           <textarea 
             value={message}
             onChange={(e) => setMessage(e.target.value)}
             className="w-full bg-slate-50 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200 resize-none"
             rows="3"
             placeholder="ì§€ì€ì´ì—ê²Œ ë”°ëœ»í•œ í•œë§ˆë””ë¥¼ ì ì–´ì£¼ì„¸ìš”..."
           ></textarea>
           <button 
             onClick={handleSendMessage}
             className="w-full mt-3 bg-blue-500 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-600 transition-colors flex items-center justify-center gap-2"
           >
             <Send size={18} /> ë©”ì‹œì§€ ì „ì†¡
           </button>
        </div>
      </main>
    </div>
  );
}

// --- í•˜ìœ„ ì»´í¬ë„ŒíŠ¸: ëª…ìƒ í”Œë ˆì´ì–´ ---
function MeditationPlayer() {
  const [isPlaying, setIsPlaying] = useState(false);
  const [timer, setTimer] = useState(180); 
  const [scriptIndex, setScriptIndex] = useState(0);

  useEffect(() => {
    let interval;
    if (isPlaying && timer > 0) {
      interval = setInterval(() => {
        setTimer((prev) => prev - 1);
        if(timer % 10 === 0 && scriptIndex < MEDITATION_SCRIPTS.length - 1) {
             setScriptIndex(prev => (prev + 1) % MEDITATION_SCRIPTS.length);
        }
      }, 1000);
    } else if (timer === 0) {
      setIsPlaying(false);
    }
    return () => clearInterval(interval);
  }, [isPlaying, timer, scriptIndex]);

  const formatTime = (seconds) => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    return `${m}:${s < 10 ? '0' : ''}${s}`;
  };

  return (
    <div className="h-full flex flex-col items-center justify-center space-y-8 p-4">
      <div className="text-center space-y-2">
        <h3 className="text-2xl font-bold text-gray-700">ë‡Œí˜¸í¡ ëª…ìƒ</h3>
        <p className="text-gray-500 text-sm">ì•„ë¡œë§ˆ í–¥ì„ ëŠë¼ë©° í˜¸í¡ì— ì§‘ì¤‘í•´ë´ìš”.</p>
      </div>
      <div className="relative flex items-center justify-center">
        <div className={`w-48 h-48 rounded-full bg-emerald-100 flex items-center justify-center transition-all duration-[4000ms] ease-in-out ${isPlaying ? 'scale-125 bg-emerald-200' : 'scale-100'}`}>
          <div className={`w-32 h-32 rounded-full bg-emerald-300 flex items-center justify-center transition-all duration-[4000ms] ease-in-out ${isPlaying ? 'scale-110 opacity-80' : 'scale-100 opacity-100'}`}>
            <span className="text-3xl font-mono font-bold text-white drop-shadow-md">
              {formatTime(timer)}
            </span>
          </div>
        </div>
        {isPlaying && (
           <div className="absolute -bottom-12 text-sm text-emerald-600 animate-pulse font-medium bg-emerald-50 px-3 py-1 rounded-full">
             ğŸŒ¿ ìˆ¨ì„ ë“¤ì´ë§ˆì‹œê³ ... ë‚´ì‰¬ì„¸ìš”...
           </div>
        )}
      </div>
      <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 w-full text-center min-h-[80px] flex items-center justify-center">
        <p className="text-gray-600 font-medium">"{MEDITATION_SCRIPTS[scriptIndex]}"</p>
      </div>
      <button 
        onClick={() => setIsPlaying(!isPlaying)}
        className={`rounded-full p-6 shadow-lg transition-transform hover:scale-105 active:scale-95 ${isPlaying ? 'bg-orange-100 text-orange-500' : 'bg-emerald-500 text-white'}`}
      >
        {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" className="ml-1" />}
      </button>
    </div>
  );
}

// --- í•˜ìœ„ ì»´í¬ë„ŒíŠ¸: ê°ì • ì¼ê¸° (ë¹ˆ ì˜ì ê¸°ë²• - DB ì €ì¥ ì—°ë™) ---
function JournalEditor({ db, appId }) {
  const [mode, setMode] = useState('gratitude'); 
  const [text, setText] = useState('');
  const [recentLogs, setRecentLogs] = useState([]);

  // ë‚´ ë¡œì»¬ì—ì„œ ì‘ì„±í•œ ë‚´ìš©ë§Œ ì ê¹ ë³´ì—¬ì£¼ê¸° ìœ„í•œ state (ì‹¤ì œë¡œëŠ” ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•„í„°ë§í•´ì„œ ë³´ì—¬ì£¼ëŠ”ê²Œ ì¢‹ìŒ)
  
  const handleSave = async () => {
    if (!text.trim()) return;
    try {
      const docRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'journals'), {
        type: mode,
        text: text,
        date: new Date().toLocaleDateString(),
        timestamp: serverTimestamp(),
        studentName: 'ì§€ì€'
      });
      
      setRecentLogs([{id: docRef.id, text, date: 'ë°©ê¸ˆ', type: mode}, ...recentLogs]);
      setText('');
      alert(mode === 'gratitude' ? 'ê°ì‚¬ ì¼ê¸°ê°€ ì €ì¥ë˜ì—ˆì–´ìš”! ê½ƒì´ í”¼ì–´ë‚¬ìŠµë‹ˆë‹¤. ğŸŒ¸' : 'ì†ë§ˆìŒì„ í„¸ì–´ë†“ìœ¼ë‹ˆ í•œê²° ê°€ë²¼ì›Œì¡Œë‚˜ìš”? ì˜í–ˆì–´ìš”.');
    } catch (e) {
      console.error(e);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };

  return (
    <div className="h-full flex flex-col space-y-4">
      <div className="flex bg-white p-1 rounded-2xl border border-gray-200">
        <button 
          onClick={() => setMode('gratitude')}
          className={`flex-1 py-2 rounded-xl text-sm font-bold transition-colors ${mode === 'gratitude' ? 'bg-yellow-100 text-yellow-700' : 'text-gray-400 hover:bg-gray-50'}`}
        >
          ğŸ™ ê°ì‚¬ ì¼ê¸°
        </button>
        <button 
          onClick={() => setMode('emptyChair')}
          className={`flex-1 py-2 rounded-xl text-sm font-bold transition-colors ${mode === 'emptyChair' ? 'bg-purple-100 text-purple-700' : 'text-gray-400 hover:bg-gray-50'}`}
        >
          ğŸª‘ ì†ë§ˆìŒ ì˜ì
        </button>
      </div>

      <div className="flex-1 bg-white rounded-3xl p-6 shadow-sm border border-gray-100 flex flex-col">
        <div className="mb-4">
          <h3 className="text-lg font-bold text-gray-800">
            {mode === 'gratitude' ? 'ì˜¤ëŠ˜ ê°ì‚¬í•œ ì¼ì„ ì°¾ì•„ë³¼ê¹Œìš”?' : 'ë¹ˆ ì˜ìì— ì•‰ì•„ ì†ë§ˆìŒì„ ë§í•´ë´ìš”.'}
          </h3>
          <p className="text-sm text-gray-400">
            {mode === 'gratitude' ? 'ì•„ì£¼ ì‚¬ì†Œí•œ ê²ƒë„ ê´œì°®ì•„ìš”.' : 'ëˆ„êµ¬ì—ê²Œë„ ë§í•˜ì§€ ëª»í•œ ì´ì•¼ê¸°, ì—¬ê¸°ì„œ ë‹¤ í„¸ì–´ë†“ìœ¼ì„¸ìš”.'}
          </p>
        </div>

        <textarea
          value={text}
          onChange={(e) => setText(e.target.value)}
          className="flex-1 w-full resize-none focus:outline-none text-gray-600 leading-relaxed placeholder-gray-300"
          placeholder={mode === 'gratitude' ? "ì˜ˆ: ì˜¤ëŠ˜ ê¸‰ì‹ì— ë§›ìˆëŠ” ë°˜ì°¬ì´ ë‚˜ì™€ì„œ ì¢‹ì•˜ë‹¤." : "ì§€ê¸ˆ ë‚´ ì•ì— ì—„ë§ˆê°€/ì¹œêµ¬ê°€ ì•‰ì•„ìˆë‹¤ê³  ìƒìƒí•´ë´. í•˜ê³  ì‹¶ì€ ë§ì„ ì ì–´ë³´ì..."}
        ></textarea>

        <div className="flex justify-between items-center mt-4 pt-4 border-t border-gray-100">
           <button className="p-3 text-gray-400 hover:bg-gray-100 rounded-full">
             <Mic size={20} />
           </button>
           <button 
             onClick={handleSave}
             className={`px-6 py-2 rounded-full text-white font-bold shadow-md transition-transform active:scale-95 ${mode === 'gratitude' ? 'bg-yellow-400 hover:bg-yellow-500' : 'bg-purple-400 hover:bg-purple-500'}`}
           >
             ì €ì¥í•˜ê¸°
           </button>
        </div>
      </div>
      
      <div className="h-32 overflow-y-auto space-y-2">
        {recentLogs.filter(j => j.type === mode).map(j => (
          <div key={j.id} className="bg-white p-3 rounded-xl text-sm text-gray-600 border border-gray-100 truncate animate-fade-in">
            <span className="text-xs text-gray-400 mr-2">{j.date}</span>
            {j.text}
          </div>
        ))}
         {recentLogs.length === 0 && <div className="text-center text-xs text-gray-300 py-4">ë°©ê¸ˆ ì“´ ë‚´ìš©ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚˜ìš”</div>}
      </div>
    </div>
  );
}

function NavButton({ active, onClick, icon, label }) {
  return (
    <button 
      onClick={onClick}
      className={`flex flex-col items-center gap-1 transition-all duration-300 ${active ? 'text-gray-800 -translate-y-2' : 'text-gray-300'}`}
    >
      <div className={`p-2 rounded-2xl ${active ? 'bg-yellow-300 shadow-md' : 'bg-transparent'}`}>
        {icon}
      </div>
      <span className="text-[10px] font-bold">{label}</span>
    </button>
  );
}
