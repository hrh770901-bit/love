<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì¡°ê° ì°¾ê¸°: ë§ˆìŒ ë´„ í”„ë¡œì íŠ¸ ì„±ì°°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #FDFBF7;
            color: #4A4A4A;
        }

        /* --- ìŠ¤íƒ€ì¼ ì •ì˜ --- */
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            height: 300px;
        }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9CA3AF; }

        /* ì• ë‹ˆë©”ì´ì…˜ ë° íš¨ê³¼ */
        .piece-card { transition: all 0.3s ease; }
        .piece-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ëª¨ìì´í¬ ì¡°ê° */
        .mosaic-piece { transition: all 0.5s ease; position: relative; }
        .mosaic-piece:hover { transform: scale(1.05); z-index: 10; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        textarea.reflection-input {
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #E5E7EB;
            resize: vertical; font-size: 0.9rem; min-height: 80px; transition: border-color 0.3s;
        }
        textarea.reflection-input:focus { outline: none; border-color: #F28C8C; box-shadow: 0 0 0 3px rgba(242, 140, 140, 0.2); }
        input.detail-input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #D1D5DB; font-size: 0.9rem; }

        /* ì¡°ê° ì‹œë®¬ë ˆì´ì…˜ ìŠ¤íƒ€ì¼ */
        .piece-base {
            transition: all 0.5s ease; width: 180px; height: 180px;
            background-color: var(--piece-color, #E74C3C);
            display: flex; align-items: center; justify-content: center; position: relative;
        }
        .shape-square { border-radius: 8px; }
        .shape-circle { border-radius: 50%; }
        .piece-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1; }
        .bounce { animation: bounce 0.6s ease-out; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ì¸ì‡„ ìŠ¤íƒ€ì¼ */
        @media print {
            body > :not(.print-container) { display: none !important; }
            .print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; color: black; }
            .print-report-card { page-break-after: always; border: 1px solid #ccc; margin-bottom: 20px; padding: 20px; }
            .print-header { font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid #333; margin-bottom: 10px; }
        }
    </style>

    <!-- Firebase ì„¤ì • ë° ì´ˆê¸°í™” -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ì„ ìƒë‹˜ê»˜ì„œ ì£¼ì‹  ì •ë³´ê°€ ì—¬ê¸°ì— ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤!
        const firebaseConfig = {
          apiKey: "AIzaSyAkKXNNA6YMDc9yRsCZ8PYDQAANv4xTulc",
          authDomain: "total-a4edf.firebaseapp.com",
          projectId: "total-a4edf",
          storageBucket: "total-a4edf.firebasestorage.app",
          messagingSenderId: "636476842816",
          appId: "1:636476842816:web:093fdccdda2ea285bd10a5",
          measurementId: "G-5LHR1DFT00"
        };

        // Firebase ì´ˆê¸°í™”
        if (firebaseConfig.apiKey) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            // ì „ì—­ ë³€ìˆ˜ë¡œ í• ë‹¹
            window.db = db;
            window.auth = auth;
            window.firebaseFunctions = { collection, addDoc, query, getDocs, serverTimestamp };

            // ìµëª… ë¡œê·¸ì¸
            signInAnonymously(auth).then(() => {
                console.log("ìµëª… ë¡œê·¸ì¸ ì„±ê³µ");
            }).catch((error) => {
                console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
            });

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    console.log("User ID:", window.userId);
                }
            });
        }
    </script>
</head>
<body class="antialiased">

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <nav class="sticky top-0 z-50 bg-[#FDFBF7]/90 backdrop-blur-md border-b border-gray-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center">
                    <span class="text-2xl mr-2">ğŸ§©</span>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">ë‚˜ì˜ ì¡°ê° ì°¾ê¸° <span class="text-sm font-normal text-gray-500 hidden sm:inline">| ë§ˆìŒ ë´„ í”„ë¡œì íŠ¸</span></h1>
                </div>
                <div class="flex space-x-4 text-sm font-medium">
                    <button onclick="scrollToSection('intro')" class="hover:text-[#F28C8C] transition-colors">ì†Œê°œ</button>
                    <button onclick="scrollToSection('phase1')" class="hover:text-[#F28C8C] transition-colors">ë‚˜ì˜ ë°œê²¬</button>
                    <button onclick="scrollToSection('phase2')" class="hover:text-[#F28C8C] transition-colors">ìš°ë¦¬ì™€ ê¸ì •</button>
                    <button onclick="scrollToSection('phase3')" class="hover:text-[#F28C8C] transition-colors">ë¯¸ë˜ì™€ ì„±ì¥</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- ì†Œê°œ ì„¹ì…˜ -->
    <section id="intro" class="max-w-4xl mx-auto px-4 py-12 sm:py-20 text-center fade-in">
        <div class="inline-block p-2 px-4 rounded-full bg-[#E9C46A]/20 text-[#96782E] text-sm font-semibold mb-4">
            ì´ˆë“±í•™êµ ë³´ê±´ ìˆ˜ì—… í”„ë¡œì íŠ¸
        </div>
        <h2 class="text-4xl sm:text-5xl font-extrabold text-gray-900 mb-6 leading-tight">
            ì‘ì€ ì¡°ê°ì´ ëª¨ì—¬<br><span class="text-[#F28C8C]">í•˜ë‚˜ì˜ ìš°ë¦¬</span>ê°€ ë˜ë‹¤
        </h2>
        <p class="text-lg text-gray-600 mb-8 max-w-2xl mx-auto leading-relaxed">
            ê·¸ë¦¼ì±… <strong>'ì‘ì€ ì¡°ê° í˜ì²´í‹°ë…¸'</strong>ë¥¼ ì½ê³  ë‚˜ë¥¼ í‘œí˜„í•˜ëŠ” ì¡°ê°ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.
            ì¹œêµ¬ë“¤ê³¼ ê¸ì •ì˜ ë§ì„ ë‚˜ëˆ„ë©° ìš°ë¦¬ëŠ” ì„œë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.
        </p>
    </section>

    <!-- Phase 1: ë‚˜ì˜ ë°œê²¬ -->
    <section id="phase1" class="bg-white py-16 border-t border-gray-100">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                <div class="order-2 lg:order-1">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="bg-[#F28C8C] text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</span>
                        <h3 class="text-2xl font-bold text-gray-900">ë‚˜ë¥¼ ë°œê²¬í•˜ëŠ” ì†Œì¤‘í•œ ì¡°ê°</h3>
                    </div>
                    
                    <!-- í•™ìƒ ì •ë³´ ì…ë ¥ -->
                    <div class="bg-[#FDFBF7] p-6 rounded-2xl border border-gray-200 shadow-sm mb-6">
                        <h4 class="font-bold text-gray-800 mb-3 border-b pb-2">âœï¸ í•™ìƒ ì •ë³´ ì…ë ¥</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div><label class="block text-xs text-gray-500 mb-1">í•™ë…„</label><input id="input-grade" type="number" class="detail-input" placeholder="5"></div>
                            <div><label class="block text-xs text-gray-500 mb-1">ë°˜</label><input id="input-class" type="number" class="detail-input" placeholder="1"></div>
                            <div><label class="block text-xs text-gray-500 mb-1">ì´ë¦„</label><input id="input-name" type="text" class="detail-input" placeholder="í™ê¸¸ë™"></div>
                        </div>
                    </div>

                    <!-- ì§ˆë¬¸ 1 -->
                    <div class="bg-[#FDFBF7] p-6 rounded-2xl border border-[#F28C8C]/20 shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-3">ğŸ¤” í•µì‹¬ ì§ˆë¬¸ 1: ìê¸° ì´í•´</h4>
                        <p class="text-sm text-gray-600 italic mb-4">"ë‚˜ë¥¼ í‘œí˜„í•˜ëŠ” 'ì‘ì€ ì¡°ê°'ì„ ì„ íƒí•˜ë©° ëª°ëë˜ ë‚˜ì˜ ì–´ë–¤ ëª¨ìŠµì„ ë°œê²¬í–ˆë‚˜ìš”?"</p>
                        <textarea id="reflection-q1" class="reflection-input" placeholder="ì—¬ê¸°ì— ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>

                <!-- ì¡°ê° ì‹œë®¬ë ˆì´ì…˜ (ìš°ì¸¡) -->
                <div class="order-1 lg:order-2 flex flex-col items-center justify-center bg-gray-50 p-8 rounded-3xl">
                    <div id="piece-canvas" class="piece-base shape-circle shadow-lg mb-6 transition-all duration-500 text-4xl text-white">
                        <span class="piece-icon">ğŸ˜€</span>
                    </div>
                    <!-- ëª¨ì–‘ ì„ íƒ -->
                    <div class="w-full max-w-sm mb-4 grid grid-cols-3 gap-2">
                        <button onclick="updatePiece('shape', 'shape-circle')" class="py-2 bg-gray-200 rounded text-sm">ğŸ”µ ë™ê·¸ë¼ë¯¸</button>
                        <button onclick="updatePiece('shape', 'shape-triangle')" class="py-2 bg-gray-200 rounded text-sm">â–² ì„¸ëª¨</button>
                        <button onclick="updatePiece('shape', 'shape-square')" class="py-2 bg-gray-200 rounded text-sm">â—¼ ë„¤ëª¨</button>
                    </div>
                    <!-- ìƒ‰ìƒ ì„ íƒ -->
                    <div class="w-full max-w-sm mb-4 grid grid-cols-8 gap-1">
                        <button onclick="updatePiece('color', '#E74C3C')" class="h-8 rounded-full bg-[#E74C3C]"></button>
                        <button onclick="updatePiece('color', '#E67E22')" class="h-8 rounded-full bg-[#E67E22]"></button>
                        <button onclick="updatePiece('color', '#F1C40F')" class="h-8 rounded-full bg-[#F1C40F]"></button>
                        <button onclick="updatePiece('color', '#27AE60')" class="h-8 rounded-full bg-[#27AE60]"></button>
                        <button onclick="updatePiece('color', '#3498DB')" class="h-8 rounded-full bg-[#3498DB]"></button>
                        <button onclick="updatePiece('color', '#5D5C8F')" class="h-8 rounded-full bg-[#5D5C8F]"></button>
                        <button onclick="updatePiece('color', '#9B59B6')" class="h-8 rounded-full bg-[#9B59B6]"></button>
                        <button onclick="updatePiece('color', '#333333')" class="h-8 rounded-full bg-[#333333]"></button>
                    </div>
                    <!-- ê°ì • ì„ íƒ -->
                    <div class="w-full max-w-sm grid grid-cols-5 gap-2">
                        <button onclick="updatePiece('icon', 'ğŸ˜€')" class="bg-white border rounded text-xl">ğŸ˜€</button>
                        <button onclick="updatePiece('icon', 'ğŸ˜‚')" class="bg-white border rounded text-xl">ğŸ˜‚</button>
                        <button onclick="updatePiece('icon', 'ğŸ˜Š')" class="bg-white border rounded text-xl">ğŸ˜Š</button>
                        <button onclick="updatePiece('icon', 'ğŸ¤©')" class="bg-white border rounded text-xl">ğŸ¤©</button>
                        <button onclick="updatePiece('icon', 'ğŸ’ª')" class="bg-white border rounded text-xl">ğŸ’ª</button>
                        <button onclick="updatePiece('icon', 'ğŸ¤”')" class="bg-white border rounded text-xl">ğŸ¤”</button>
                        <button onclick="updatePiece('icon', 'ğŸ˜­')" class="bg-white border rounded text-xl">ğŸ˜­</button>
                        <button onclick="updatePiece('icon', 'ğŸ˜ ')" class="bg-white border rounded text-xl">ğŸ˜ </button>
                        <button onclick="updatePiece('icon', 'ğŸ˜´')" class="bg-white border rounded text-xl">ğŸ˜´</button>
                        <button onclick="updatePiece('icon', 'ğŸ˜‡')" class="bg-white border rounded text-xl">ğŸ˜‡</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Phase 2: ìš°ë¦¬ì™€ ê¸ì • -->
    <section id="phase2" class="py-16 bg-[#FDFBF7]">
        <div class="max-w-6xl mx-auto px-4 sm:px-6">
            <div class="text-center mb-12">
                <span class="bg-[#84A98C] text-white px-3 py-1 rounded-full text-xs font-bold">Phase 2</span>
                <h3 class="text-3xl font-bold text-gray-900 mt-2">ìš°ë¦¬ í•¨ê»˜ ë§Œë“œëŠ” ê¸ì •ì˜ í˜</h3>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4 text-center">ê¸ì • ëŒ“ê¸€ í™œë™ íš¨ê³¼</h4>
                    <div class="chart-container"><canvas id="communityChart"></canvas></div>
                </div>
                <div class="flex flex-col justify-center space-y-6">
                     <!-- ì§ˆë¬¸ 2 -->
                     <div class="bg-white p-6 rounded-2xl border-l-4 border-[#84A98C] shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-2">ğŸ’¬ í•µì‹¬ ì§ˆë¬¸ 2: ê´€ê³„</h4>
                        <p class="text-sm text-gray-600 mb-3 italic">"ì¹œêµ¬ë“¤ì—ê²Œ ê¸ì • ëŒ“ê¸€ì„ ë‹¬ì•„ì£¼ì—ˆì„ ë•Œ, ë‚˜ì—ê²ŒëŠ” ì–´ë–¤ ê¸°ë¶„ì´ ë“¤ì—ˆë‚˜ìš”?"</p>
                        <textarea id="reflection-q2" class="reflection-input" placeholder="ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                    </div>
                    <!-- ì§ˆë¬¸ 3 -->
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-[#E9C46A] shadow-sm">
                        <h4 class="font-bold text-gray-800 mb-2">ğŸ§© í•µì‹¬ ì§ˆë¬¸ 3: ê³µë™ì²´</h4>
                        <p class="text-sm text-gray-600 mb-3 italic">"ëª¨ë‘ ë‹¤ë¥¸ ì¡°ê°ë“¤ì´ ëª¨ì—¬ ìš°ë¦¬ ë°˜ì„ ì™„ì„±í–ˆì–´ìš”. ë‚˜ëŠ” ì–´ë–¤ ì—­í• ì„ í•  ìˆ˜ ìˆì„ê¹Œìš”?"</p>
                        <textarea id="reflection-q3" class="reflection-input" placeholder="ë‹µë³€ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
                    </div>
                </div>
            </div>

            <!-- ëª¨ìì´í¬ ê·¸ë¦¬ë“œ -->
            <div class="bg-white p-8 rounded-3xl shadow-inner text-center relative">
                <h4 class="text-lg font-bold text-gray-800 mb-6">ìš°ë¦¬ ë°˜ ì¡°ê° ëª¨ì•„ë³´ê¸°</h4>
                <div id="mosaic-detail-display" class="hidden mb-6 bg-gray-50 p-4 rounded-xl border text-left"></div>
                <div class="grid grid-cols-5 gap-2 max-w-3xl mx-auto" id="mosaic-grid"></div>
            </div>
        </div>
    </section>

    <!-- Phase 3: ë¯¸ë˜ì™€ ì„±ì¥ -->
    <section id="phase3" class="py-16 bg-white border-t border-gray-100">
        <div class="max-w-4xl mx-auto px-4">
            <div class="flex items-center gap-2 mb-8">
                <span class="bg-[#E9C46A] text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">3</span>
                <h3 class="text-2xl font-bold text-gray-900">ì¡°ê°ì˜ í™•ì¥ê³¼ ë©‹ì§„ ë¯¸ë˜</h3>
            </div>
            
            <div class="bg-[#FDFBF7] rounded-3xl p-8 md:p-12 relative overflow-hidden">
                <!-- ì§ˆë¬¸ 4 -->
                <div class="mb-8 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h5 class="font-bold text-gray-800 mb-2">ğŸ“¢ í•µì‹¬ ì§ˆë¬¸ 4: ë‚˜ì˜ ì™¸ì¹¨</h5>
                    <p class="text-sm text-gray-600 mb-4 italic">"ë‚˜ì˜ ì¡°ê°ì´ ì„¸ìƒì— ì™¸ì¹  ìˆ˜ ìˆë‹¤ë©´, ê·¸ ë§ì€ ì–´ë–¤ ê¸ì •ì ì¸ ë³€í™”ë¥¼ ê°€ì ¸ì˜¬ê¹Œìš”?"</p>
                    <textarea id="reflection-q4" class="reflection-input" placeholder="ë‚˜ì˜ í•œë§ˆë””ì™€ ë³€í™”ë¥¼ ì ì–´ë³´ì„¸ìš”."></textarea>
                </div>

                <!-- ì„±ì¥ ê³„íš -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h5 class="font-bold text-gray-800 mb-3">ğŸŒ± ë‚˜ì˜ ì„±ì¥ ë‹¤ì§</h5>
                    <textarea id="reflection-q_plan" class="reflection-input" placeholder="ê°€ì¥ ì†Œì¤‘í•œ ê¹¨ë‹¬ìŒê³¼ ì•ìœ¼ë¡œì˜ ì„±ì¥ ê³„íšì„ ì ì–´ë³´ì„¸ìš”."></textarea>
                </div>
                
                <!-- ì œì¶œ ë²„íŠ¼ -->
                <div class="mt-8 text-center">
                    <button onclick="submitReflection()" class="bg-[#F28C8C] text-white py-3 px-8 rounded-xl font-bold text-lg hover:bg-[#D47979] transition duration-300 shadow-lg transform hover:scale-105">
                        âœ… ì„ ìƒë‹˜ê»˜ ì œì¶œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- êµì‚¬ ì „ìš© ì¶œë ¥ -->
    <section class="max-w-4xl mx-auto px-4 py-8 text-center border-t-2 border-[#84A98C]">
        <h3 class="text-xl font-bold text-gray-700 mb-4">ğŸ‘©â€ğŸ« êµì‚¬ ì „ìš©: ë³´ê³ ì„œ ì¶œë ¥</h3>
        <button onclick="generatePrintReport()" class="bg-[#3498DB] text-white py-2 px-6 rounded-xl font-semibold hover:bg-[#2980B9] shadow-md">
            ğŸ–¨ï¸ í•™ìƒ ë‹µë³€ ëª¨ì•„ë³´ê¸° (ì¸ì‡„/PDF)
        </button>
    </section>

    <!-- ì¸ì‡„ìš© ì»¨í…Œì´ë„ˆ -->
    <div id="print-container" class="print-container hidden"></div>

    <!-- ì•Œë¦¼ì°½ UI -->
    <div id="custom-message-box" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl z-[100] text-center max-w-sm border-t-4 border-[#F28C8C] hidden">
        <p id="custom-message-text" class="text-gray-800 font-medium whitespace-pre-wrap mb-4"></p>
        <button onclick="closeMessageBox()" class="bg-[#F28C8C] text-white py-2 px-4 rounded-lg text-sm hover:bg-[#D47979]">í™•ì¸</button>
    </div>

    <!-- ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ -->
    <script>
        // --- ì „ì—­ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function scrollToSection(id) {
            const el = document.getElementById(id);
            if (el) el.scrollIntoView({ behavior: 'smooth' });
        }

        function showCustomMessage(msg) {
            const box = document.getElementById('custom-message-box');
            document.getElementById('custom-message-text').textContent = msg;
            box.classList.remove('hidden');
        }
        function closeMessageBox() {
            document.getElementById('custom-message-box').classList.add('hidden');
        }

        // --- ì¡°ê° ì‹œë®¬ë ˆì´ì…˜ ë¡œì§ ---
        const pieceCanvas = document.getElementById('piece-canvas');
        const pieceIcon = pieceCanvas.querySelector('.piece-icon');
        let pieceState = { shape: 'shape-circle', color: '#E74C3C', icon: 'ğŸ˜€' };

        function updatePiece(type, value) {
            // ì´ˆê¸°í™”
            pieceCanvas.className = `piece-base ${pieceState.shape} shadow-lg mb-6 transition-all duration-500 text-4xl text-white flex items-center justify-center`;
            pieceCanvas.style = ""; // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            pieceCanvas.style.backgroundColor = pieceState.color;

            if (type === 'shape') {
                pieceState.shape = value;
                pieceCanvas.classList.remove('shape-circle', 'shape-square', 'shape-triangle');
                pieceCanvas.classList.add(value);
            } else if (type === 'color') pieceState.color = value;
            else if (type === 'icon') { pieceState.icon = value; pieceIcon.textContent = value; }

            // ì„¸ëª¨ì¼ ê²½ìš° íŠ¹ìˆ˜ ì²˜ë¦¬
            if (pieceState.shape === 'shape-triangle') {
                pieceCanvas.style.backgroundColor = 'transparent';
                pieceCanvas.style.width = '0'; pieceCanvas.style.height = '0';
                pieceCanvas.style.borderLeft = '90px solid transparent';
                pieceCanvas.style.borderRight = '90px solid transparent';
                pieceCanvas.style.borderBottom = `150px solid ${pieceState.color}`;
                pieceIcon.style.top = '60%'; // ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì •
            } else {
                pieceCanvas.style.backgroundColor = pieceState.color;
                pieceIcon.style.top = '50%';
            }

            // ë…¸ë€ìƒ‰ì¼ ê²½ìš° ê¸€ì ê²€ì •ìƒ‰
            if (pieceState.color === '#F1C40F') pieceIcon.classList.replace('text-white', 'text-black');
            else pieceIcon.classList.replace('text-black', 'text-white');

            // ì• ë‹ˆë©”ì´ì…˜
            pieceCanvas.classList.remove('bounce');
            void pieceCanvas.offsetWidth;
            pieceCanvas.classList.add('bounce');
        }

        // --- Firebase ì œì¶œ ë¡œì§ ---
        async function submitReflection() {
            if (!window.db) {
                showCustomMessage('âš ï¸ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(ì½”ë“œ ìƒë‹¨ì˜ configë¥¼ í™•ì¸í•˜ì„¸ìš”)');
                return;
            }

            const grade = document.getElementById('input-grade').value;
            const classNum = document.getElementById('input-class').value;
            const name = document.getElementById('input-name').value;
            const q1 = document.getElementById('reflection-q1').value;
            const q2 = document.getElementById('reflection-q2').value;
            const q3 = document.getElementById('reflection-q3').value;
            const q4 = document.getElementById('reflection-q4').value;
            const q_plan = document.getElementById('reflection-q_plan').value;

            if (!grade || !classNum || !name) { showCustomMessage('í•™ë…„, ë°˜, ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!'); return; }
            if (!q1 || !q2 || !q3 || !q4 || !q_plan) { showCustomMessage('ëª¨ë“  ì§ˆë¬¸ì— ë‹µì„ ì ì–´ì£¼ì„¸ìš”!'); return; }

            try {
                const { collection, addDoc, serverTimestamp } = window.firebaseFunctions;
                // 'student_reflections' ë¼ëŠ” ì´ë¦„ì˜ ì €ì¥ì†Œì— ì €ì¥
                await addDoc(collection(window.db, "student_reflections"), {
                    grade, classNum, name,
                    q1, q2, q3, q4, q_plan,
                    timestamp: serverTimestamp(),
                    userId: window.userId || 'anonymous'
                });
                showCustomMessage(`ğŸ‰ ${name} í•™ìƒì˜ ë‹µë³€ì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                // ì…ë ¥ì°½ ë¹„ìš°ê¸°
                document.querySelectorAll('input, textarea').forEach(el => el.value = '');
            } catch (e) {
                console.error(e);
                showCustomMessage('âŒ ì œì¶œ ì‹¤íŒ¨: ' + e.message);
            }
        }

        // --- êµì‚¬ ì¶œë ¥ ë¡œì§ ---
        async function generatePrintReport() {
            if (!window.db) { showCustomMessage('DB ì—°ê²° ì•ˆë¨'); return; }
            const container = document.getElementById('print-container');
            container.innerHTML = '<div class="text-center p-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            container.classList.remove('hidden');

            try {
                const { collection, getDocs, query } = window.firebaseFunctions;
                const snap = await getDocs(query(collection(window.db, "student_reflections")));
                
                if (snap.empty) {
                    showCustomMessage('ì €ì¥ëœ í•™ìƒ ë‹µë³€ì´ ì—†ìŠµë‹ˆë‹¤.');
                    container.classList.add('hidden');
                    return;
                }

                let html = '<h1 style="text-align:center; padding:20px;">[ë§ˆìŒ ë´„] í•™ìƒ ì„±ì°° ë³´ê³ ì„œ</h1>';
                
                // ë°ì´í„° ì •ë ¬ (í•™ë…„-ë°˜-ì´ë¦„ ìˆœ)
                const docs = [];
                snap.forEach(d => docs.push(d.data()));
                docs.sort((a,b) => (a.classNum - b.classNum) || a.name.localeCompare(b.name));

                docs.forEach(data => {
                    html += `
                        <div class="print-report-card">
                            <div class="print-header">${data.grade}í•™ë…„ ${data.classNum}ë°˜ ${data.name}</div>
                            <h4>1. ìê¸° ì´í•´</h4><p>${data.q1}</p>
                            <h4>2. ê´€ê³„</h4><p>${data.q2}</p>
                            <h4>3. ê³µë™ì²´</h4><p>${data.q3}</p>
                            <h4>4. ë‚˜ì˜ ì™¸ì¹¨</h4><p>${data.q4}</p>
                            <h4>5. ì„±ì¥ ë‹¤ì§</h4><p>${data.q_plan}</p>
                        </div>
                    `;
                });

                container.innerHTML = html;
                setTimeout(() => { window.print(); container.classList.add('hidden'); }, 1000);

            } catch (e) {
                console.error(e);
                showCustomMessage('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message);
                container.classList.add('hidden');
            }
        }

        // --- ì°¨íŠ¸ ë° ëª¨ìì´í¬ ì´ˆê¸°í™” ---
        document.addEventListener('DOMContentLoaded', () => {
            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            new Chart(document.getElementById('communityChart'), {
                type: 'radar',
                data: {
                    labels: ['ìì•„ì¡´ì¤‘ê°', 'ì¹œë°€ê°', 'ì†Œì†ê°', 'ê³µê°', 'í‘œí˜„ë ¥'],
                    datasets: [{
                        label: 'í™œë™ ì „', data: [3, 3, 2, 3, 3],
                        borderColor: '#ccc', backgroundColor: 'rgba(200,200,200,0.2)'
                    }, {
                        label: 'í™œë™ í›„', data: [5, 4.5, 4.8, 5, 4.5],
                        borderColor: '#84A98C', backgroundColor: 'rgba(132, 169, 140, 0.2)'
                    }]
                },
                options: { scales: { r: { suggestedMin: 0, suggestedMax: 5 } } }
            });

            // ëª¨ìì´í¬ ìƒì„± (ë‹¨ìˆœ ì‹œê°ìš©)
            const grid = document.getElementById('mosaic-grid');
            const colors = ['#E74C3C', '#E67E22', '#F1C40F', '#27AE60', '#3498DB', '#9B59B6'];
            for(let i=1; i<=20; i++) {
                const div = document.createElement('div');
                div.className = "h-12 rounded bg-opacity-80 flex items-center justify-center text-white font-bold cursor-pointer hover:scale-110 transition";
                div.style.backgroundColor = colors[i % colors.length];
                div.innerText = i;
                div.onclick = () => showCustomMessage(`${i}ë²ˆ ì¡°ê°ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤!`);
                grid.appendChild(div);
            }
        });
    </script>
</body>
</html>