<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë§ˆìŒ ì •ì› ğŸŒ±</title>
    <!-- 1. ë””ìì¸ ë„êµ¬ (Tailwind CSS) ê°€ì ¸ì˜¤ê¸° -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. ë¦¬ì•¡íŠ¸ ì–¸ì–´ ë²ˆì—­ê¸° (Babel) ê°€ì ¸ì˜¤ê¸° -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 3. ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ -->
    <style>
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { font-family: "Pretendard", sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-bounce-in { animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes bounceIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <!-- 4. ì—¬ê¸°ì„œë¶€í„° ì§„ì§œ ì•± ì½”ë“œì…ë‹ˆë‹¤ -->
    <script type="text/babel" data-type="module">
        // ì¸í„°ë„·ì—ì„œ í•„ìš”í•œ ë„êµ¬ë“¤ì„ ì§ì ‘ ê°€ì ¸ì˜µë‹ˆë‹¤ (CDN ë°©ì‹)
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { Heart, Wind, BookOpen, Phone, AlertCircle, User, LogOut, Send, Mic, Play, Pause, X, Wifi, WifiOff } from 'https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0';
        
        // íŒŒì´ì–´ë² ì´ìŠ¤ ë„êµ¬ ê°€ì ¸ì˜¤ê¸°
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- â­ ì„ ìƒë‹˜ì˜ LOVE í”„ë¡œì íŠ¸ ë¹„ë°€ ì—´ì‡  ---
        const firebaseConfig = {
            apiKey: "AIzaSyATOUHaxLyQpKSnh3tSTKbE545Z3hrpd00",
            authDomain: "love-c5ddb.firebaseapp.com",
            projectId: "love-c5ddb",
            storageBucket: "love-c5ddb.firebasestorage.app",
            messagingSenderId: "333805011394",
            appId: "1:333805011394:web:50dcb1c7544ed07f23d65b"
        };

        // ì•± ì‹œì‘!
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'mind-garden-class-6-2';

        // --- ë°ì´í„° ì •ì˜ ---
        const MOOD_COLORS = [
            { id: 'joy', color: 'bg-yellow-300', text: 'ê¸°ì¨/í¬ë§', message: 'ë…¸ë€ í–‡ì‚´ì²˜ëŸ¼ ë°ì€ ë§ˆìŒì´êµ¬ë‚˜!' },
            { id: 'calm', color: 'bg-green-300', text: 'í‰ì˜¨/íœ´ì‹', message: 'ì´ˆë¡ ë‚˜ë¬´ì²˜ëŸ¼ í¸ì•ˆí•œ ëŠë‚Œì´ë„¤.' },
            { id: 'sad', color: 'bg-blue-300', text: 'ìŠ¬í””/ìš°ìš¸', message: 'íŒŒë€ ë¹„ê°€ ë‚´ë¦¬ëŠ”êµ¬ë‚˜. ê´œì°®ì•„, ê·¸ëŸ´ ìˆ˜ ìˆì–´.' },
            { id: 'angry', color: 'bg-red-400', text: 'í™”ë‚¨/ì—ë„ˆì§€', message: 'ë¶‰ì€ ë¶ˆê½ƒì´ ì¼ì–´ë‚˜ëŠ”êµ¬ë‚˜. ì‹¬í˜¸í¡ì„ í•´ë³¼ê¹Œ?' },
            { id: 'anxious', color: 'bg-purple-300', text: 'ë¶ˆì•ˆ/ê³ ë¯¼', message: 'ë³´ëë¹› ì•ˆê°œ ì†ì— ìˆë‹ˆ? ì„ ìƒë‹˜ì´ ì† ì¡ì•„ì¤„ê²Œ.' },
        ];

        const MEDITATION_SCRIPTS = [
            "ì, í¸ì•ˆí•˜ê²Œ ì•‰ì•„ë³´ì. ì„ ìƒë‹˜ì´ ì¤€ ë¼ë²¤ë” ì˜¤ì¼ í–¥ê¸°ë¥¼ ê¹Šê²Œ ë“¤ì´ë§ˆì…”ë´... (ìˆ¨ ë“¤ì´ë§ˆì‹œê¸°)",
            "ë‚´ ë§ˆìŒì†ì— ìˆëŠ” ë¶ˆì•ˆí•œ í’ì„ ì´ ì²œì²œíˆ ë°”ëŒì´ ë¹ ì ¸ë‚˜ê°„ë‹¤ê³  ìƒìƒí•´ë´... (ìˆ¨ ë‚´ì‰¬ê¸°)",
            "ë„ˆëŠ” ì•ˆì „í•´. ì§€ê¸ˆ ì´ ìˆœê°„, ë„ˆì˜ ìˆ¨ì†Œë¦¬ì—ë§Œ ì§‘ì¤‘í•´ ë³´ì."
        ];

        // --- ë©”ì¸ ì»´í¬ë„ŒíŠ¸ ---
        function MindGardenApp() {
            const [user, setUser] = useState(null);
            const [userType, setUserType] = useState(null);
            const [moodLogs, setMoodLogs] = useState([]);
            const [sosActive, setSosActive] = useState(false);
            const [isOnline, setIsOnline] = useState(false);
            const [authError, setAuthError] = useState(null);

            // ë¡œê·¸ì¸ ì²˜ë¦¬
            useEffect(() => {
                signInAnonymously(auth).catch(e => {
                    console.error(e);
                    setAuthError(e.message);
                });
                return onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setIsOnline(!!u);
                });
            }, []);

            // ë°ì´í„° ì‹¤ì‹œê°„ ì—°ë™
            useEffect(() => {
                if (!user) return;
                const moodQuery = collection(db, 'artifacts', appId, 'public', 'data', 'mood_logs');
                const unsub = onSnapshot(moodQuery, (sn) => {
                    const logs = sn.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                    setMoodLogs(logs);
                });
                return () => unsub();
            }, [user]);

            // ë¡œê·¸ì¸ í™”ë©´ ë Œë”ë§
            if (!userType) {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-pink-50 p-6">
                        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center space-y-8 animate-fade-in">
                            <div className="space-y-2">
                                <h1 className="text-3xl font-bold text-gray-800">ğŸŒ± ë§ˆìŒ ì •ì›</h1>
                                <p className="text-gray-500">ë„ˆì™€ ë‚˜, ìš°ë¦¬ê°€ ì—°ê²°ë˜ëŠ” ê³³</p>
                            </div>
                            <div className="space-y-4">
                                <button onClick={() => setUserType('student')} className="w-full py-4 bg-emerald-100 text-emerald-800 rounded-2xl font-bold flex justify-center gap-2 hover:scale-105 transition-transform">
                                    <User size={24} /> í•™ìƒ ì…ì¥í•˜ê¸°
                                </button>
                                <button onClick={() => setUserType('teacher')} className="w-full py-4 bg-blue-100 text-blue-800 rounded-2xl font-bold flex justify-center gap-2 hover:scale-105 transition-transform">
                                    <BookOpen size={24} /> ì„ ìƒë‹˜ ì…ì¥
                                </button>
                            </div>
                            <div className="text-xs text-gray-400 mt-4">
                                {isOnline ? <span className="text-emerald-500 flex justify-center items-center gap-1"><Wifi size={12}/> ì„œë²„ ì—°ê²°ë¨</span> : "ì—°ê²° ì¤‘..."}
                                {authError && <div className="text-red-400 mt-1">ì˜¤ë¥˜: ë„ë©”ì¸ í—ˆìš© í•„ìš” ({authError})</div>}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="h-screen w-full flex justify-center bg-gray-100 overflow-hidden">
                    <div className="w-full max-w-md bg-white h-full shadow-2xl relative flex flex-col">
                        {userType === 'student' 
                            ? <StudentView moodLogs={moodLogs} setSosActive={setSosActive} sosActive={sosActive} onLogout={() => setUserType(null)} db={db} appId={appId} />
                            : <TeacherView moodLogs={moodLogs} onLogout={() => setUserType(null)} db={db} appId={appId} />
                        }
                    </div>
                </div>
            );
        }

        // --- í•™ìƒ í™”ë©´ ---
        function StudentView({ moodLogs, setSosActive, sosActive, onLogout, db, appId }) {
            const [activeTab, setActiveTab] = useState('home');
            const [todayMood, setTodayMood] = useState(null);
            const [latestMessage, setLatestMessage] = useState(null);

            useEffect(() => {
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
                return onSnapshot(q, (sn) => {
                    const msgs = sn.docs.map(d => d.data()).sort((a,b) => (b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
                    if(msgs.length > 0) setLatestMessage(msgs[0]);
                });
            }, []);

            const handleMood = async (mood) => {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mood_logs'), {
                    mood: mood.id, date: new Date().toLocaleDateString(), timestamp: serverTimestamp(), studentName: 'ì§€ì€'
                });
                setTodayMood(mood);
            };

            return (
                <div className="flex-1 flex flex-col relative bg-amber-50/30">
                    <header className="p-6 pt-12 flex justify-between bg-white shadow-sm rounded-b-3xl z-10">
                        <div><h2 className="text-2xl font-bold text-gray-800">ì•ˆë…•, ì§€ì€ì•„! ğŸ‘‹</h2><p className="text-sm text-gray-500">ì˜¤ëŠ˜ë„ ì†Œì¤‘í•œ í•˜ë£¨ì•¼</p></div>
                        <button onClick={onLogout}><LogOut className="text-gray-400" /></button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-6 pb-24 space-y-6">
                        <button onClick={() => setSosActive(true)} className="w-full bg-red-100 text-red-600 p-4 rounded-2xl font-bold flex justify-center gap-2 animate-pulse">
                            <AlertCircle /> ì§€ê¸ˆ ë§ˆìŒì´ ë„ˆë¬´ í˜ë“¤ì–´ìš” (SOS)
                        </button>

                        {activeTab === 'home' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                                    <h3 className="font-bold text-gray-700 mb-4">ì˜¤ëŠ˜ ë§ˆìŒ ìƒ‰ê¹”ì€?</h3>
                                    {todayMood ? (
                                        <div className={`p-6 rounded-2xl ${todayMood.color} text-center space-y-2`}>
                                            <div className="text-3xl">âœ¨</div>
                                            <p className="font-bold text-gray-800">{todayMood.text}</p>
                                            <p className="text-sm text-gray-800/80">{todayMood.message}</p>
                                            <button onClick={() => setTodayMood(null)} className="text-xs underline mt-2">ë‹¤ì‹œ ì„ íƒí•˜ê¸°</button>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-5 gap-2">
                                            {MOOD_COLORS.map(m => (
                                                <button key={m.id} onClick={() => handleMood(m)} className={`h-14 rounded-2xl ${m.color} hover:scale-110 transition-transform shadow-sm`} />
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="bg-blue-50 p-6 rounded-3xl shadow-sm border border-blue-100 relative overflow-hidden">
                                    <h3 className="text-blue-800 font-bold mb-2 flex items-center gap-2"><Heart size={16} fill="currentColor"/> ì„ ìƒë‹˜ì˜ ì‘ì›</h3>
                                    <p className="text-blue-900 font-medium">"{latestMessage ? latestMessage.text : "ì§€ì€ì•„, í˜ë“¤ë©´ ì–¸ì œë“  ë¹ˆ ì˜ìì— í„¸ì–´ë†“ìœ¼ë ´. ì„ ìƒë‹˜ì€ ëŠ˜ ë„¤ í¸ì´ì•¼."}"</p>
                                </div>
                            </div>
                        )}
                        {activeTab === 'meditation' && <MeditationPlayer />}
                        {activeTab === 'journal' && <JournalEditor db={db} appId={appId} />}
                    </main>

                    {sosActive && (
                        <div className="absolute inset-0 bg-black/60 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white w-full rounded-3xl p-8 text-center relative animate-bounce-in">
                                <button onClick={() => setSosActive(false)} className="absolute top-4 right-4 p-2 text-gray-400"><X /></button>
                                <div className="w-16 h-16 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4"><Phone size={32}/></div>
                                <h3 className="text-2xl font-bold mb-2">í˜¼ìê°€ ì•„ë‹ˆì•¼</h3>
                                <div className="space-y-3 mt-6">
                                    <button className="w-full py-4 bg-pink-500 text-white rounded-xl font-bold shadow-lg">ì—„ë§ˆì—ê²Œ ì „í™”í•˜ê¸°</button>
                                    <button className="w-full py-4 bg-gray-200 text-gray-700 rounded-xl font-bold">ìƒë‹´ì„¼í„° (1388)</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="absolute bottom-0 w-full bg-white border-t border-gray-100 flex justify-around p-4 pb-8 rounded-t-3xl">
                        <NavButton active={activeTab==='home'} onClick={()=>setActiveTab('home')} icon={<Heart/>} label="í™ˆ" />
                        <NavButton active={activeTab==='meditation'} onClick={()=>setActiveTab('meditation')} icon={<Wind/>} label="ëª…ìƒ" />
                        <NavButton active={activeTab==='journal'} onClick={()=>setActiveTab('journal')} icon={<BookOpen/>} label="ì¼ê¸°" />
                    </nav>
                </div>
            );
        }

        // --- ì„ ìƒë‹˜ í™”ë©´ ---
        function TeacherView({ moodLogs, onLogout, db, appId }) {
            const [msg, setMsg] = useState('');
            const dangerCount = moodLogs.filter(l => l.mood === 'sad' || l.mood === 'angry').length;

            const sendMsg = async () => {
                if(!msg.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'messages'), {
                    text: msg, timestamp: serverTimestamp(), sender: 'teacher'
                });
                alert("ì „ì†¡ ì™„ë£Œ!"); setMsg('');
            };

            return (
                <div className="flex-1 flex flex-col bg-slate-50">
                    <header className="p-6 pt-12 bg-white shadow-sm flex justify-between">
                        <div><h2 className="text-xl font-bold">ğŸ‘©â€ğŸ« í•™ìƒ ì¼€ì–´ ëŒ€ì‹œë³´ë“œ</h2><p className="text-sm text-slate-500">ê¹€ì§€ì€ í•™ìƒ (ì‹¤ì‹œê°„)</p></div>
                        <button onClick={onLogout}><LogOut className="text-gray-400"/></button>
                    </header>
                    <main className="p-6 space-y-6 flex-1 overflow-y-auto">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                                <h4 className="text-xs font-bold text-slate-400 mb-2">ìµœê·¼ ê°ì •</h4>
                                <div className="flex items-end h-12 gap-1">
                                    {moodLogs.slice(0,5).map((l,i) => (
                                        <div key={i} className={`flex-1 rounded-t-lg h-full opacity-80 ${MOOD_COLORS.find(c=>c.id===l.mood)?.color || 'bg-gray-200'}`}></div>
                                    ))}
                                </div>
                            </div>
                            <div className={`p-4 rounded-2xl border ${dangerCount>0 ? 'bg-red-50 border-red-200' : 'bg-emerald-50 border-emerald-200'}`}>
                                <h4 className="text-xs font-bold mb-2">ê´€ì‹¬ í•„ìš” ì§€ìˆ˜</h4>
                                <div className="flex items-center gap-2 text-2xl font-bold">
                                    <AlertCircle className={dangerCount>0?'text-red-500':'text-emerald-500'} />
                                    <span className={dangerCount>0?'text-red-600':'text-emerald-600'}>{dangerCount>0?'ì£¼ì˜':'ì•ˆì •'}</span>
                                </div>
                            </div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                            <h3 className="font-bold mb-3">ğŸ’Œ ê²©ë ¤ ë©”ì‹œì§€</h3>
                            <textarea value={msg} onChange={e=>setMsg(e.target.value)} className="w-full bg-slate-50 rounded-xl p-3 text-sm resize-none mb-2" rows="3" placeholder="ì§€ì€ì´ì—ê²Œ ë³´ë‚¼ ì‘ì›..."></textarea>
                            <button onClick={sendMsg} className="w-full bg-blue-500 text-white py-3 rounded-xl font-bold flex justify-center gap-2"><Send size={18}/> ì „ì†¡</button>
                        </div>
                    </main>
                </div>
            );
        }

        // --- ê¸°íƒ€ ì»´í¬ë„ŒíŠ¸ ---
        function MeditationPlayer() {
            const [play, setPlay] = useState(false);
            const [time, setTime] = useState(180);
            
            useEffect(() => {
                let i; 
                if(play && time > 0) i = setInterval(() => setTime(t => t-1), 1000);
                return () => clearInterval(i);
            }, [play, time]);

            return (
                <div className="h-full flex flex-col items-center justify-center space-y-8 p-4">
                    <div className="text-center"><h3 className="text-2xl font-bold">ë‡Œí˜¸í¡ ëª…ìƒ</h3><p className="text-gray-500">í˜¸í¡ì— ì§‘ì¤‘í•´ë³´ì„¸ìš”</p></div>
                    <div className={`w-48 h-48 rounded-full bg-emerald-100 flex items-center justify-center transition-all duration-[4000ms] ${play?'scale-110':''}`}>
                        <div className="text-3xl font-bold text-emerald-600">{Math.floor(time/60)}:{(time%60).toString().padStart(2,'0')}</div>
                    </div>
                    <button onClick={() => setPlay(!play)} className="bg-emerald-500 text-white p-4 rounded-full shadow-lg">
                        {play ? <Pause fill="white"/> : <Play fill="white" className="ml-1"/>}
                    </button>
                </div>
            );
        }

        function JournalEditor({ db, appId }) {
            const [mode, setMode] = useState('gratitude');
            const [txt, setTxt] = useState('');
            const save = async () => {
                if(!txt.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'journals'), {
                    type: mode, text: txt, date: new Date().toLocaleDateString(), timestamp: serverTimestamp()
                });
                alert("ì €ì¥ë˜ì—ˆì–´ìš”! ğŸŒ¸"); setTxt('');
            };
            return (
                <div className="h-full flex flex-col space-y-4">
                    <div className="flex bg-white p-1 rounded-2xl border">
                        <button onClick={()=>setMode('gratitude')} className={`flex-1 py-2 rounded-xl font-bold text-sm ${mode==='gratitude'?'bg-yellow-100 text-yellow-700':'text-gray-400'}`}>ğŸ™ ê°ì‚¬ ì¼ê¸°</button>
                        <button onClick={()=>setMode('emptyChair')} className={`flex-1 py-2 rounded-xl font-bold text-sm ${mode==='emptyChair'?'bg-purple-100 text-purple-700':'text-gray-400'}`}>ğŸª‘ ì†ë§ˆìŒ ì˜ì</button>
                    </div>
                    <div className="flex-1 bg-white rounded-3xl p-6 border border-gray-100 flex flex-col">
                        <textarea value={txt} onChange={e=>setTxt(e.target.value)} className="flex-1 resize-none focus:outline-none" placeholder={mode==='gratitude'?"ì˜¤ëŠ˜ ê³ ë§ˆì› ë˜ ì¼ì€?":"ëˆ„êµ¬ì—ê²Œë„ ëª»í•œ ë§..."}></textarea>
                        <div className="flex justify-end pt-4"><button onClick={save} className="bg-yellow-400 text-white px-6 py-2 rounded-full font-bold shadow-md">ì €ì¥</button></div>
                    </div>
                </div>
            );
        }

        function NavButton({ active, onClick, icon, label }) {
            return <button onClick={onClick} className={`flex flex-col items-center gap-1 ${active?'text-gray-800':'text-gray-300'}`}><div className={active?'bg-yellow-300 p-2 rounded-2xl shadow-md':'p-2'}>{icon}</div><span className="text-[10px] font-bold">{label}</span></button>;
        }

        // í™”ë©´ì— ì•± ê·¸ë¦¬ê¸°
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MindGardenApp />);
    </script>
</body>
</html>
